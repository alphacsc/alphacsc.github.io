
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_examples/multicsc/plot_sample_evoked_response.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        Click :ref:`here <sphx_glr_download_auto_examples_multicsc_plot_sample_evoked_response.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_multicsc_plot_sample_evoked_response.py:


=====================================================================
Extracting artifact and evoked response atoms from the sample dataset
=====================================================================

This example illustrates how to learn rank-1 [1]_ atoms on the multivariate
sample dataset from :code:`mne`. We display a selection of atoms, featuring
heartbeat and eyeblink artifacts, two atoms of evoked responses, and a
non-sinusoidal oscillation.

.. [1] Dupré La Tour, T., Moreau, T., Jas, M., & Gramfort, A. (2018).
    `Multivariate Convolutional Sparse Coding for Electromagnetic Brain Signals
    <https://arxiv.org/abs/1805.09654v2>`_. Advances in Neural Information
    Processing Systems (NIPS).

.. GENERATED FROM PYTHON SOURCE LINES 17-26

.. code-block:: default


    # Authors: Thomas Moreau <thomas.moreau@inria.fr>
    #          Mainak Jas <mainak.jas@telecom-paristech.fr>
    #          Tom Dupre La Tour <tom.duprelatour@telecom-paristech.fr>
    #          Alexandre Gramfort <alexandre.gramfort@telecom-paristech.fr>
    #
    # License: BSD (3-clause)









.. GENERATED FROM PYTHON SOURCE LINES 27-28

Let us first define the parameters of our model.

.. GENERATED FROM PYTHON SOURCE LINES 28-49

.. code-block:: default


    # sampling frequency. The signal will be resampled to match this.
    sfreq = 150.

    # Define the shape of the dictionary
    n_atoms = 40
    n_times_atom = int(round(sfreq * 1.0))  # 1000. ms

    # Regularization parameter which control sparsity
    reg = 0.1

    # number of processors for parallel computing
    n_jobs = 5

    # To accelerate the run time of this example, we split the signal in n_slits.
    # The number of splits should actually be the smallest possible to avoid
    # introducing border artifacts in the learned atoms and it should be not much
    # larger than n_jobs.
    n_splits = 10









.. GENERATED FROM PYTHON SOURCE LINES 50-51

Next, we define the parameters for multivariate CSC

.. GENERATED FROM PYTHON SOURCE LINES 51-87

.. code-block:: default


    from alphacsc import GreedyCDL
    cdl = GreedyCDL(
        # Shape of the dictionary
        n_atoms=n_atoms,
        n_times_atom=n_times_atom,
        # Request a rank1 dictionary with unit norm temporal and spatial maps
        rank1=True,
        uv_constraint='separate',
        # apply a temporal window reparametrization
        window=True,
        # at the end, refit the activations with fixed support and no reg to unbias
        unbiased_z_hat=True,
        # Initialize the dictionary with random chunk from the data
        D_init='chunk',
        # rescale the regularization parameter to be a percentage of lambda_max
        lmbd_max="scaled",
        reg=reg,
        # Number of iteration for the alternate minimization and cvg threshold
        n_iter=100,
        eps=1e-4,
        # solver for the z-step
        solver_z="lgcd",
        solver_z_kwargs={'tol': 1e-3,
                         'max_iter': 100000},
        # solver for the d-step
        solver_d='alternate_adaptive',
        solver_d_kwargs={'max_iter': 300},
        # sort atoms by explained variances
        sort_atoms=True,
        # Technical parameters
        verbose=1,
        random_state=0,
        n_jobs=n_jobs)









.. GENERATED FROM PYTHON SOURCE LINES 88-92

Load the sample data from MNE-python and select the gradiometer channels.
The MNE sample data contains MEG recordings of a subject with visual and
auditory stimuli. We load the data using utilities from MNE-python as a Raw
object and select the gradiometers from the signal.

.. GENERATED FROM PYTHON SOURCE LINES 92-107

.. code-block:: default


    import os
    import mne
    import numpy as np

    print("Loading the data...", end='', flush=True)
    data_path = mne.datasets.sample.data_path()
    subjects_dir = os.path.join(data_path, "subjects")
    data_dir = os.path.join(data_path, 'MEG', 'sample')
    file_name = os.path.join(data_dir, 'sample_audvis_raw.fif')
    raw = mne.io.read_raw_fif(file_name, preload=True, verbose=False)
    raw.pick_types(meg='grad', eeg=False, eog=False, stim=True)
    print('done')






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Loading the data...Using default location ~/mne_data for sample...
      0%|                                              | 0.00/1.65G [00:00<?, ?B/s]      0%|                                     | 3.44M/1.65G [00:00<00:47, 34.4MB/s]      1%|▏                                    | 9.98M/1.65G [00:00<00:31, 52.6MB/s]      1%|▎                                    | 16.6M/1.65G [00:00<00:27, 58.6MB/s]      1%|▌                                    | 23.1M/1.65G [00:00<00:26, 61.5MB/s]      2%|▋                                    | 29.7M/1.65G [00:00<00:25, 63.0MB/s]      2%|▊                                    | 36.4M/1.65G [00:00<00:25, 64.2MB/s]      3%|▉                                    | 42.9M/1.65G [00:00<00:24, 64.7MB/s]      3%|█                                    | 49.5M/1.65G [00:00<00:24, 65.0MB/s]      3%|█▎                                   | 56.1M/1.65G [00:00<00:24, 65.3MB/s]      4%|█▍                                   | 62.7M/1.65G [00:01<00:24, 65.5MB/s]      4%|█▌                                   | 69.3M/1.65G [00:01<00:24, 65.5MB/s]      5%|█▋                                   | 75.8M/1.65G [00:01<00:24, 65.6MB/s]      5%|█▊                                   | 82.4M/1.65G [00:01<00:23, 65.7MB/s]      5%|█▉                                   | 89.0M/1.65G [00:01<00:23, 65.7MB/s]      6%|██▏                                  | 95.6M/1.65G [00:01<00:23, 65.7MB/s]      6%|██▎                                   | 102M/1.65G [00:01<00:23, 65.8MB/s]      7%|██▌                                   | 109M/1.65G [00:01<00:23, 65.8MB/s]      7%|██▋                                   | 115M/1.65G [00:01<00:23, 65.9MB/s]      7%|██▊                                   | 122M/1.65G [00:01<00:23, 65.9MB/s]      8%|██▉                                   | 129M/1.65G [00:02<00:23, 66.0MB/s]      8%|███                                   | 135M/1.65G [00:02<00:22, 66.0MB/s]      9%|███▎                                  | 142M/1.65G [00:02<00:22, 66.1MB/s]      9%|███▍                                  | 148M/1.65G [00:02<00:22, 66.0MB/s]      9%|███▌                                  | 155M/1.65G [00:02<00:22, 66.0MB/s]     10%|███▋                                  | 162M/1.65G [00:02<00:22, 66.1MB/s]     10%|███▊                                  | 168M/1.65G [00:02<00:22, 66.1MB/s]     11%|████                                  | 175M/1.65G [00:02<00:22, 66.1MB/s]     11%|████▏                                 | 182M/1.65G [00:02<00:22, 66.0MB/s]     11%|████▎                                 | 188M/1.65G [00:02<00:23, 62.3MB/s]     12%|████▍                                 | 195M/1.65G [00:03<00:23, 63.3MB/s]     12%|████▋                                 | 201M/1.65G [00:03<00:22, 64.1MB/s]     13%|████▊                                 | 208M/1.65G [00:03<00:22, 64.7MB/s]     13%|████▉                                 | 215M/1.65G [00:03<00:22, 65.1MB/s]     13%|█████                                 | 221M/1.65G [00:03<00:21, 65.4MB/s]     14%|█████▏                                | 228M/1.65G [00:03<00:21, 65.6MB/s]     14%|█████▍                                | 234M/1.65G [00:03<00:21, 65.8MB/s]     15%|█████▌                                | 241M/1.65G [00:03<00:21, 65.9MB/s]     15%|█████▋                                | 248M/1.65G [00:03<00:21, 66.0MB/s]     15%|█████▊                                | 254M/1.65G [00:03<00:21, 66.0MB/s]     16%|█████▉                                | 261M/1.65G [00:04<00:21, 65.8MB/s]     16%|██████▏                               | 267M/1.65G [00:04<00:21, 65.7MB/s]     17%|██████▎                               | 274M/1.65G [00:04<00:20, 65.7MB/s]     17%|██████▍                               | 281M/1.65G [00:04<00:20, 65.9MB/s]     17%|██████▌                               | 287M/1.65G [00:04<00:20, 65.9MB/s]     18%|██████▊                               | 294M/1.65G [00:04<00:20, 65.6MB/s]     18%|██████▉                               | 300M/1.65G [00:04<00:20, 65.2MB/s]     19%|███████                               | 307M/1.65G [00:04<00:20, 64.8MB/s]     19%|███████▏                              | 313M/1.65G [00:04<00:20, 64.7MB/s]     19%|███████▎                              | 320M/1.65G [00:04<00:20, 64.7MB/s]     20%|███████▌                              | 326M/1.65G [00:05<00:20, 64.9MB/s]     20%|███████▋                              | 333M/1.65G [00:05<00:25, 52.8MB/s]     21%|███████▊                              | 339M/1.65G [00:05<00:23, 55.0MB/s]     21%|███████▉                              | 345M/1.65G [00:05<00:22, 57.4MB/s]     21%|████████                              | 352M/1.65G [00:05<00:21, 59.5MB/s]     22%|████████▏                             | 358M/1.65G [00:05<00:21, 60.9MB/s]     22%|████████▍                             | 365M/1.65G [00:05<00:20, 61.8MB/s]     22%|████████▌                             | 371M/1.65G [00:05<00:20, 62.1MB/s]     23%|████████▋                             | 377M/1.65G [00:05<00:20, 62.0MB/s]     23%|████████▊                             | 384M/1.65G [00:06<00:20, 62.8MB/s]     24%|████████▉                             | 390M/1.65G [00:06<00:19, 63.6MB/s]     24%|█████████                             | 397M/1.65G [00:06<00:19, 64.0MB/s]     24%|█████████▎                            | 403M/1.65G [00:06<00:19, 64.6MB/s]     25%|█████████▍                            | 410M/1.65G [00:06<00:19, 64.9MB/s]     25%|█████████▌                            | 417M/1.65G [00:06<00:18, 65.2MB/s]     26%|█████████▋                            | 423M/1.65G [00:06<00:18, 65.3MB/s]     26%|█████████▉                            | 430M/1.65G [00:06<00:18, 65.5MB/s]     26%|██████████                            | 436M/1.65G [00:06<00:18, 65.6MB/s]     27%|██████████▏                           | 443M/1.65G [00:06<00:18, 65.6MB/s]     27%|██████████▎                           | 449M/1.65G [00:07<00:18, 65.5MB/s]     28%|██████████▍                           | 456M/1.65G [00:07<00:18, 65.6MB/s]     28%|██████████▋                           | 463M/1.65G [00:07<00:18, 65.8MB/s]     28%|██████████▊                           | 469M/1.65G [00:07<00:17, 65.9MB/s]     29%|██████████▉                           | 476M/1.65G [00:07<00:17, 65.9MB/s]     29%|███████████                           | 482M/1.65G [00:07<00:17, 65.8MB/s]     30%|███████████▏                          | 489M/1.65G [00:07<00:17, 65.8MB/s]     30%|███████████▍                          | 496M/1.65G [00:07<00:17, 65.7MB/s]     30%|███████████▌                          | 502M/1.65G [00:07<00:17, 65.6MB/s]     31%|███████████▋                          | 509M/1.65G [00:07<00:17, 65.6MB/s]     31%|███████████▊                          | 515M/1.65G [00:08<00:17, 65.7MB/s]     32%|███████████▉                          | 522M/1.65G [00:08<00:17, 65.7MB/s]     32%|████████████▏                         | 528M/1.65G [00:08<00:17, 65.6MB/s]     32%|████████████▎                         | 535M/1.65G [00:08<00:17, 65.7MB/s]     33%|████████████▍                         | 542M/1.65G [00:08<00:16, 65.6MB/s]     33%|████████████▌                         | 548M/1.65G [00:08<00:16, 65.8MB/s]     34%|████████████▊                         | 555M/1.65G [00:08<00:16, 65.8MB/s]     34%|████████████▉                         | 561M/1.65G [00:08<00:16, 65.7MB/s]     34%|█████████████                         | 568M/1.65G [00:08<00:16, 65.7MB/s]     35%|█████████████▏                        | 575M/1.65G [00:08<00:16, 65.7MB/s]     35%|█████████████▎                        | 581M/1.65G [00:09<00:16, 65.8MB/s]     36%|█████████████▌                        | 588M/1.65G [00:09<00:16, 66.1MB/s]     36%|█████████████▋                        | 594M/1.65G [00:09<00:16, 65.9MB/s]     36%|█████████████▊                        | 601M/1.65G [00:09<00:16, 65.6MB/s]     37%|█████████████▉                        | 608M/1.65G [00:09<00:15, 65.8MB/s]     37%|██████████████                        | 614M/1.65G [00:09<00:15, 65.8MB/s]     38%|██████████████▎                       | 621M/1.65G [00:09<00:25, 40.7MB/s]     38%|██████████████▍                       | 627M/1.65G [00:09<00:22, 45.9MB/s]     38%|██████████████▌                       | 634M/1.65G [00:10<00:20, 50.4MB/s]     39%|██████████████▋                       | 640M/1.65G [00:10<00:18, 54.1MB/s]     39%|██████████████▉                       | 647M/1.65G [00:10<00:17, 57.2MB/s]     40%|███████████████                       | 654M/1.65G [00:10<00:16, 59.6MB/s]     40%|███████████████▏                      | 660M/1.65G [00:10<00:16, 61.3MB/s]     40%|███████████████▎                      | 667M/1.65G [00:10<00:15, 62.7MB/s]     41%|███████████████▍                      | 673M/1.65G [00:10<00:15, 63.6MB/s]     41%|███████████████▋                      | 680M/1.65G [00:10<00:15, 64.2MB/s]     42%|███████████████▊                      | 687M/1.65G [00:10<00:14, 64.7MB/s]     42%|███████████████▉                      | 693M/1.65G [00:10<00:14, 65.0MB/s]     42%|████████████████                      | 700M/1.65G [00:11<00:14, 65.2MB/s]     43%|████████████████▏                     | 706M/1.65G [00:11<00:14, 65.4MB/s]     43%|████████████████▍                     | 713M/1.65G [00:11<00:14, 65.6MB/s]     44%|████████████████▌                     | 720M/1.65G [00:11<00:14, 65.6MB/s]     44%|████████████████▋                     | 726M/1.65G [00:11<00:14, 65.7MB/s]     44%|████████████████▊                     | 733M/1.65G [00:11<00:13, 65.9MB/s]     45%|████████████████▉                     | 739M/1.65G [00:11<00:13, 66.0MB/s]     45%|█████████████████▏                    | 746M/1.65G [00:11<00:13, 66.1MB/s]     46%|█████████████████▎                    | 753M/1.65G [00:11<00:13, 66.1MB/s]     46%|█████████████████▍                    | 759M/1.65G [00:11<00:13, 66.2MB/s]     46%|█████████████████▌                    | 766M/1.65G [00:12<00:13, 66.2MB/s]     47%|█████████████████▊                    | 773M/1.65G [00:12<00:13, 66.2MB/s]     47%|█████████████████▉                    | 779M/1.65G [00:12<00:13, 66.2MB/s]     48%|██████████████████                    | 786M/1.65G [00:12<00:13, 66.3MB/s]     48%|██████████████████▏                   | 792M/1.65G [00:12<00:13, 66.2MB/s]     48%|██████████████████▎                   | 799M/1.65G [00:12<00:12, 66.2MB/s]     49%|██████████████████▌                   | 806M/1.65G [00:12<00:12, 66.2MB/s]     49%|██████████████████▋                   | 812M/1.65G [00:12<00:12, 66.2MB/s]     50%|██████████████████▊                   | 819M/1.65G [00:12<00:12, 66.3MB/s]     50%|██████████████████▉                   | 826M/1.65G [00:12<00:12, 66.4MB/s]     50%|███████████████████▏                  | 832M/1.65G [00:13<00:12, 66.3MB/s]     51%|███████████████████▎                  | 839M/1.65G [00:13<00:12, 66.4MB/s]     51%|███████████████████▍                  | 846M/1.65G [00:13<00:12, 66.4MB/s]     52%|███████████████████▌                  | 852M/1.65G [00:13<00:12, 66.4MB/s]     52%|███████████████████▋                  | 859M/1.65G [00:13<00:11, 66.3MB/s]     52%|███████████████████▉                  | 866M/1.65G [00:13<00:11, 66.5MB/s]     53%|████████████████████                  | 872M/1.65G [00:13<00:11, 66.3MB/s]     53%|████████████████████▏                 | 879M/1.65G [00:13<00:11, 66.2MB/s]     54%|████████████████████▎                 | 885M/1.65G [00:13<00:11, 66.1MB/s]     54%|████████████████████▌                 | 892M/1.65G [00:13<00:11, 66.0MB/s]     54%|████████████████████▋                 | 899M/1.65G [00:14<00:11, 66.1MB/s]     55%|████████████████████▊                 | 905M/1.65G [00:14<00:11, 66.1MB/s]     55%|████████████████████▉                 | 912M/1.65G [00:14<00:11, 66.0MB/s]     56%|█████████████████████                 | 918M/1.65G [00:14<00:11, 65.9MB/s]     56%|█████████████████████▎                | 925M/1.65G [00:14<00:11, 65.9MB/s]     56%|█████████████████████▍                | 932M/1.65G [00:14<00:10, 65.8MB/s]     57%|█████████████████████▌                | 938M/1.65G [00:14<00:10, 65.9MB/s]     57%|█████████████████████▋                | 945M/1.65G [00:14<00:10, 66.0MB/s]     58%|█████████████████████▉                | 952M/1.65G [00:14<00:10, 66.1MB/s]     58%|██████████████████████                | 958M/1.65G [00:14<00:10, 66.2MB/s]     58%|██████████████████████▏               | 965M/1.65G [00:15<00:10, 66.1MB/s]     59%|██████████████████████▎               | 971M/1.65G [00:15<00:12, 55.9MB/s]     59%|██████████████████████▍               | 978M/1.65G [00:15<00:11, 58.4MB/s]     60%|██████████████████████▋               | 985M/1.65G [00:15<00:11, 60.6MB/s]     60%|██████████████████████▊               | 991M/1.65G [00:15<00:10, 62.2MB/s]     60%|██████████████████████▉               | 998M/1.65G [00:15<00:10, 63.4MB/s]     61%|██████████████████████▍              | 1.00G/1.65G [00:15<00:10, 64.2MB/s]     61%|██████████████████████▋              | 1.01G/1.65G [00:15<00:09, 64.9MB/s]     62%|██████████████████████▊              | 1.02G/1.65G [00:15<00:09, 65.3MB/s]     62%|██████████████████████▉              | 1.02G/1.65G [00:15<00:09, 65.6MB/s]     62%|███████████████████████              | 1.03G/1.65G [00:16<00:09, 65.8MB/s]     63%|███████████████████████▏             | 1.04G/1.65G [00:16<00:09, 66.0MB/s]     63%|███████████████████████▍             | 1.04G/1.65G [00:16<00:09, 66.1MB/s]     64%|███████████████████████▌             | 1.05G/1.65G [00:16<00:09, 66.2MB/s]     64%|███████████████████████▋             | 1.06G/1.65G [00:16<00:09, 65.9MB/s]     64%|███████████████████████▊             | 1.06G/1.65G [00:16<00:08, 65.8MB/s]     65%|███████████████████████▉             | 1.07G/1.65G [00:16<00:08, 65.8MB/s]     65%|████████████████████████             | 1.08G/1.65G [00:16<00:08, 65.8MB/s]     66%|████████████████████████▎            | 1.08G/1.65G [00:16<00:08, 65.8MB/s]     66%|████████████████████████▍            | 1.09G/1.65G [00:16<00:08, 65.9MB/s]     66%|████████████████████████▌            | 1.10G/1.65G [00:17<00:08, 66.0MB/s]     67%|████████████████████████▋            | 1.10G/1.65G [00:17<00:08, 65.9MB/s]     67%|████████████████████████▊            | 1.11G/1.65G [00:17<00:08, 65.9MB/s]     68%|█████████████████████████            | 1.12G/1.65G [00:17<00:08, 65.9MB/s]     68%|█████████████████████████▏           | 1.12G/1.65G [00:17<00:08, 66.0MB/s]     68%|█████████████████████████▎           | 1.13G/1.65G [00:17<00:07, 65.9MB/s]     69%|█████████████████████████▍           | 1.14G/1.65G [00:17<00:07, 66.0MB/s]     69%|█████████████████████████▌           | 1.14G/1.65G [00:17<00:07, 65.9MB/s]     70%|█████████████████████████▋           | 1.15G/1.65G [00:17<00:07, 65.8MB/s]     70%|█████████████████████████▉           | 1.16G/1.65G [00:17<00:07, 65.8MB/s]     70%|██████████████████████████           | 1.16G/1.65G [00:18<00:07, 65.8MB/s]     71%|██████████████████████████▏          | 1.17G/1.65G [00:18<00:07, 65.9MB/s]     71%|██████████████████████████▎          | 1.18G/1.65G [00:18<00:07, 65.9MB/s]     72%|██████████████████████████▍          | 1.18G/1.65G [00:18<00:07, 65.9MB/s]     72%|██████████████████████████▋          | 1.19G/1.65G [00:18<00:07, 66.0MB/s]     72%|██████████████████████████▊          | 1.20G/1.65G [00:18<00:06, 66.1MB/s]     73%|██████████████████████████▉          | 1.20G/1.65G [00:18<00:06, 66.1MB/s]     73%|███████████████████████████          | 1.21G/1.65G [00:18<00:06, 66.2MB/s]     74%|███████████████████████████▏         | 1.22G/1.65G [00:18<00:06, 66.1MB/s]     74%|███████████████████████████▎         | 1.22G/1.65G [00:18<00:06, 66.0MB/s]     74%|███████████████████████████▌         | 1.23G/1.65G [00:19<00:06, 66.0MB/s]     75%|███████████████████████████▋         | 1.24G/1.65G [00:19<00:06, 66.0MB/s]     75%|███████████████████████████▊         | 1.24G/1.65G [00:19<00:06, 66.1MB/s]     76%|███████████████████████████▉         | 1.25G/1.65G [00:19<00:06, 66.2MB/s]     76%|████████████████████████████         | 1.26G/1.65G [00:19<00:06, 66.0MB/s]     76%|████████████████████████████▎        | 1.26G/1.65G [00:19<00:05, 66.1MB/s]     77%|████████████████████████████▍        | 1.27G/1.65G [00:19<00:05, 66.0MB/s]     77%|████████████████████████████▌        | 1.28G/1.65G [00:19<00:05, 66.0MB/s]     78%|████████████████████████████▋        | 1.28G/1.65G [00:19<00:05, 66.0MB/s]     78%|████████████████████████████▊        | 1.29G/1.65G [00:19<00:05, 66.0MB/s]     78%|████████████████████████████▉        | 1.30G/1.65G [00:20<00:05, 65.9MB/s]     79%|█████████████████████████████▏       | 1.30G/1.65G [00:20<00:05, 65.9MB/s]     79%|█████████████████████████████▎       | 1.31G/1.65G [00:20<00:05, 65.9MB/s]     80%|█████████████████████████████▍       | 1.32G/1.65G [00:20<00:05, 65.9MB/s]     80%|█████████████████████████████▌       | 1.32G/1.65G [00:20<00:05, 65.9MB/s]     80%|█████████████████████████████▋       | 1.33G/1.65G [00:20<00:04, 65.9MB/s]     81%|█████████████████████████████▉       | 1.34G/1.65G [00:20<00:04, 66.0MB/s]     81%|██████████████████████████████       | 1.34G/1.65G [00:20<00:04, 66.0MB/s]     82%|██████████████████████████████▏      | 1.35G/1.65G [00:20<00:04, 65.9MB/s]     82%|██████████████████████████████▎      | 1.35G/1.65G [00:20<00:04, 65.9MB/s]     82%|██████████████████████████████▍      | 1.36G/1.65G [00:21<00:04, 65.9MB/s]     83%|██████████████████████████████▋      | 1.37G/1.65G [00:21<00:04, 66.0MB/s]     83%|██████████████████████████████▊      | 1.37G/1.65G [00:21<00:04, 66.0MB/s]     84%|██████████████████████████████▉      | 1.38G/1.65G [00:21<00:04, 66.1MB/s]     84%|███████████████████████████████      | 1.39G/1.65G [00:21<00:04, 66.1MB/s]     84%|███████████████████████████████▏     | 1.39G/1.65G [00:21<00:03, 66.1MB/s]     85%|███████████████████████████████▎     | 1.40G/1.65G [00:21<00:03, 66.1MB/s]     85%|███████████████████████████████▌     | 1.41G/1.65G [00:21<00:03, 66.2MB/s]     86%|███████████████████████████████▋     | 1.41G/1.65G [00:21<00:03, 66.2MB/s]     86%|███████████████████████████████▊     | 1.42G/1.65G [00:21<00:03, 66.2MB/s]     86%|███████████████████████████████▉     | 1.43G/1.65G [00:22<00:03, 66.2MB/s]     87%|████████████████████████████████     | 1.43G/1.65G [00:22<00:03, 66.2MB/s]     87%|████████████████████████████████▎    | 1.44G/1.65G [00:22<00:03, 66.2MB/s]     88%|████████████████████████████████▍    | 1.45G/1.65G [00:22<00:03, 66.3MB/s]     88%|████████████████████████████████▌    | 1.45G/1.65G [00:22<00:03, 55.4MB/s]     88%|████████████████████████████████▋    | 1.46G/1.65G [00:22<00:03, 58.1MB/s]     89%|████████████████████████████████▊    | 1.47G/1.65G [00:22<00:03, 60.1MB/s]     89%|████████████████████████████████▉    | 1.47G/1.65G [00:22<00:02, 61.8MB/s]     90%|█████████████████████████████████▏   | 1.48G/1.65G [00:22<00:02, 63.1MB/s]     90%|█████████████████████████████████▎   | 1.49G/1.65G [00:23<00:02, 64.1MB/s]     90%|█████████████████████████████████▍   | 1.49G/1.65G [00:23<00:02, 64.7MB/s]     91%|█████████████████████████████████▌   | 1.50G/1.65G [00:23<00:02, 65.2MB/s]     91%|█████████████████████████████████▋   | 1.51G/1.65G [00:23<00:02, 65.5MB/s]     92%|█████████████████████████████████▉   | 1.51G/1.65G [00:23<00:02, 65.7MB/s]     92%|██████████████████████████████████   | 1.52G/1.65G [00:23<00:02, 65.8MB/s]     92%|██████████████████████████████████▏  | 1.53G/1.65G [00:23<00:01, 65.9MB/s]     93%|██████████████████████████████████▎  | 1.53G/1.65G [00:23<00:01, 66.1MB/s]     93%|██████████████████████████████████▍  | 1.54G/1.65G [00:23<00:01, 66.2MB/s]     94%|██████████████████████████████████▋  | 1.55G/1.65G [00:23<00:01, 66.2MB/s]     94%|██████████████████████████████████▊  | 1.55G/1.65G [00:24<00:01, 66.2MB/s]     94%|██████████████████████████████████▉  | 1.56G/1.65G [00:24<00:01, 65.9MB/s]     95%|███████████████████████████████████  | 1.57G/1.65G [00:24<00:01, 65.8MB/s]     95%|███████████████████████████████████▏ | 1.57G/1.65G [00:24<00:01, 65.9MB/s]     96%|███████████████████████████████████▎ | 1.58G/1.65G [00:24<00:01, 66.0MB/s]     96%|███████████████████████████████████▌ | 1.59G/1.65G [00:24<00:01, 66.0MB/s]     96%|███████████████████████████████████▋ | 1.59G/1.65G [00:24<00:00, 66.1MB/s]     97%|███████████████████████████████████▊ | 1.60G/1.65G [00:24<00:00, 66.2MB/s]     97%|███████████████████████████████████▉ | 1.61G/1.65G [00:24<00:00, 66.3MB/s]     98%|████████████████████████████████████ | 1.61G/1.65G [00:24<00:00, 66.2MB/s]     98%|████████████████████████████████████▎| 1.62G/1.65G [00:25<00:00, 66.2MB/s]     98%|████████████████████████████████████▍| 1.63G/1.65G [00:25<00:00, 65.7MB/s]     99%|████████████████████████████████████▌| 1.63G/1.65G [00:25<00:00, 65.7MB/s]     99%|████████████████████████████████████▋| 1.64G/1.65G [00:25<00:00, 65.8MB/s]    100%|████████████████████████████████████▊| 1.65G/1.65G [00:25<00:00, 65.9MB/s]    100%|████████████████████████████████████▉| 1.65G/1.65G [00:25<00:00, 66.0MB/s]      0%|                                              | 0.00/1.65G [00:00<?, ?B/s]    100%|█████████████████████████████████████| 1.65G/1.65G [00:00<00:00, 3.36TB/s]
    Removing projector <Projection | PCA-v1, active : False, n_channels : 102>
    Removing projector <Projection | PCA-v2, active : False, n_channels : 102>
    Removing projector <Projection | PCA-v3, active : False, n_channels : 102>
    done




.. GENERATED FROM PYTHON SOURCE LINES 108-111

Then, we remove the powerline artifacts and high-pass filter to remove the
drift which can impact the CSC technique. The signal is also resampled to
150 Hz to reduce the computationnal burden.

.. GENERATED FROM PYTHON SOURCE LINES 111-119

.. code-block:: default


    print("Preprocessing the data...", end='', flush=True)
    raw.notch_filter(np.arange(60, 181, 60), n_jobs=n_jobs, verbose=False)
    raw.filter(2, None, n_jobs=n_jobs, verbose=False)
    raw = raw.resample(sfreq, npad='auto', n_jobs=n_jobs, verbose=False)
    print('done')






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Preprocessing the data.../github/workspace/examples/multicsc/plot_sample_evoked_response.py:115: RuntimeWarning: Resampling of the stim channels caused event information to become unreliable. Consider finding events on the original data and passing the event matrix as a parameter.
      raw = raw.resample(sfreq, npad='auto', n_jobs=n_jobs, verbose=False)
    done




.. GENERATED FROM PYTHON SOURCE LINES 120-124

Load the data as an array and split it in chunks to allow parallel processing
during the model fit. Each split is considered as independent.
To reduce the impact of border artifacts, we use `apply_window=True`
which scales down the border of each split with a tukey window.

.. GENERATED FROM PYTHON SOURCE LINES 124-131

.. code-block:: default


    from alphacsc.utils import split_signal
    X = raw.get_data(picks=['meg'])
    info = raw.copy().pick_types(meg=True).info  # info of the loaded channels
    X_split = split_signal(X, n_splits=n_splits, apply_window=True)









.. GENERATED FROM PYTHON SOURCE LINES 132-133

Fit the model and learn rank1 atoms

.. GENERATED FROM PYTHON SOURCE LINES 133-137

.. code-block:: default


    cdl.fit(X_split)






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    ./github/workspace/alphacsc/utils/optim.py:136: DeprecationWarning: Please use `scalar_search_armijo` from the `scipy.optimize` namespace, the `scipy.optimize.linesearch` namespace is deprecated.
      step_size, obj_uv = optimize.linesearch.scalar_search_armijo(
    ................................................+
    ......
    [GreedyCDL] Converged after 56 iteration, (dz, du) = 9.514e-05, 6.597e-05
    [GreedyCDL] Fit in 4987.4s

    <alphacsc.convolutional_dictionary_learning.GreedyCDL object at 0x7f216fce0e50>



.. GENERATED FROM PYTHON SOURCE LINES 138-142

Then we call the `transform` method, which returns the sparse codes
associated with X, without changing the dictionary learned during the `fit`.
Note that we transform on the *unsplit* data so that the sparse codes
reflect the original data and not the windowed data.

.. GENERATED FROM PYTHON SOURCE LINES 142-145

.. code-block:: default

    z_hat = cdl.transform(X[None, :])






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Refitting the activation to avoid amplitude bias...done




.. GENERATED FROM PYTHON SOURCE LINES 146-151

Display a selection of atoms
----------------------------

We recognize a heartbeat artifact, an eyeblink artifact, two atoms of evoked
responses, and a non-sinusoidal oscillation.

.. GENERATED FROM PYTHON SOURCE LINES 151-200

.. code-block:: default


    import matplotlib.pyplot as plt

    # preselected atoms of interest
    plotted_atoms = [0, 1, 2, 6, 4]

    n_plots = 3  # number of plots by atom
    n_columns = min(6, len(plotted_atoms))
    split = int(np.ceil(len(plotted_atoms) / n_columns))
    figsize = (4 * n_columns, 3 * n_plots * split)
    fig, axes = plt.subplots(n_plots * split, n_columns, figsize=figsize)
    for ii, kk in enumerate(plotted_atoms):

        # Select the axes to display the current atom
        print("\rDisplaying {}-th atom".format(kk), end='', flush=True)
        i_row, i_col = ii // n_columns, ii % n_columns
        it_axes = iter(axes[i_row * n_plots:(i_row + 1) * n_plots, i_col])

        # Select the current atom
        u_k = cdl.u_hat_[kk]
        v_k = cdl.v_hat_[kk]

        # Plot the spatial map of the atom using mne topomap
        ax = next(it_axes)
        mne.viz.plot_topomap(u_k, info, axes=ax, show=False)
        ax.set(title="Spatial pattern %d" % (kk, ))

        # Plot the temporal pattern of the atom
        ax = next(it_axes)
        t = np.arange(n_times_atom) / sfreq
        ax.plot(t, v_k)
        ax.set_xlim(0, n_times_atom / sfreq)
        ax.set(xlabel='Time (sec)', title="Temporal pattern %d" % kk)

        # Plot the power spectral density (PSD)
        ax = next(it_axes)
        psd = np.abs(np.fft.rfft(v_k, n=256)) ** 2
        frequencies = np.linspace(0, sfreq / 2.0, len(psd))
        ax.semilogy(frequencies, psd, label='PSD', color='k')
        ax.set(xlabel='Frequencies (Hz)', title="Power spectral density %d" % kk)
        ax.grid(True)
        ax.set_xlim(0, 30)
        ax.set_ylim(1e-4, 1e2)
        ax.legend()
    print("\rDisplayed {} atoms".format(len(plotted_atoms)).rjust(40))

    fig.tight_layout()





.. image-sg:: /auto_examples/multicsc/images/sphx_glr_plot_sample_evoked_response_001.png
   :alt: Spatial pattern 0, Spatial pattern 1, Spatial pattern 2, Spatial pattern 6, Spatial pattern 4, Temporal pattern 0, Temporal pattern 1, Temporal pattern 2, Temporal pattern 6, Temporal pattern 4, Power spectral density 0, Power spectral density 1, Power spectral density 2, Power spectral density 6, Power spectral density 4
   :srcset: /auto_examples/multicsc/images/sphx_glr_plot_sample_evoked_response_001.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Displaying 0-th atom    Displaying 1-th atom    Displaying 2-th atom    Displaying 6-th atom    Displaying 4-th atom                          Displayed 5 atoms




.. GENERATED FROM PYTHON SOURCE LINES 201-209

Display the evoked reconstructed envelope
-----------------------------------------

The MNE sample data contains data for auditory (event_id=1 and 2) and
visual stimuli (event_id=3 and 4). We extract the events now so that we can
later identify the atoms related to different events. Note that the
convolutional sparse coding method does not need to know the events for
learning atoms.

.. GENERATED FROM PYTHON SOURCE LINES 209-216

.. code-block:: default


    event_id = [1, 2, 3, 4]
    events = mne.find_events(raw, stim_channel='STI 014')
    events = mne.pick_events(events, include=event_id)
    events[:, 0] -= raw.first_samp






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    319 events found
    Event IDs: [ 1  2  3  4  5 32]




.. GENERATED FROM PYTHON SOURCE LINES 217-222

For each atom (columns), and for each event (rows), we compute the envelope
of the reconstructed signal, align it with respect to the event onsets, and
take the average. For some atoms, the activations are correlated with the
events, leading to a large evoked envelope. The gray area corresponds to
not statistically significant values, computing with sampling.

.. GENERATED FROM PYTHON SOURCE LINES 222-267

.. code-block:: default


    from alphacsc.utils.signal import fast_hilbert
    from alphacsc.viz.epoch import plot_evoked_surrogates
    from alphacsc.utils.convolution import construct_X_multi

    # time window around the events. Note that for the sample datasets, the time
    # inter-event is around 0.5s
    t_lim = (-0.1, 0.5)

    n_plots = len(event_id)
    n_columns = min(6, len(plotted_atoms))
    split = int(np.ceil(len(plotted_atoms) / n_columns))
    figsize = (4 * n_columns, 3 * n_plots * split)
    fig, axes = plt.subplots(n_plots * split, n_columns, figsize=figsize)

    for ii, kk in enumerate(plotted_atoms):

        # Select the axes to display the current atom
        print("\rDisplaying {}-th atom envelope".format(kk), end='', flush=True)
        i_row, i_col = ii // n_columns, ii % n_columns
        it_axes = iter(axes[i_row * n_plots:(i_row + 1) * n_plots, i_col])

        # Select the current atom
        v_k = cdl.v_hat_[kk]
        v_k_1 = np.r_[[1], v_k][None]
        z_k = z_hat[:, kk:kk + 1]
        X_k = construct_X_multi(z_k, v_k_1, n_channels=1)[0, 0]

        # compute the 'envelope' of the reconstructed signal X_k
        correlation = np.abs(fast_hilbert(X_k))

        # loop over all events IDs
        for this_event_id in event_id:
            this_events = events[events[:, 2] == this_event_id]
            # plotting function
            ax = next(it_axes)
            this_info = info.copy()
            event_info = dict(event_id = this_event_id, events=events)
            this_info['temp'] = event_info
            plot_evoked_surrogates(correlation, info=this_info, t_lim=t_lim, ax=ax,
                                   n_jobs=n_jobs, label='event %d' % this_event_id)
            ax.set(xlabel='Time (sec)', title="Evoked envelope %d" % kk)
    print("\rDisplayed {} atoms".format(len(plotted_atoms)).rjust(40))
    fig.tight_layout()




.. image-sg:: /auto_examples/multicsc/images/sphx_glr_plot_sample_evoked_response_002.png
   :alt: Evoked envelope 0, Evoked envelope 1, Evoked envelope 2, Evoked envelope 6, Evoked envelope 4, Evoked envelope 0, Evoked envelope 1, Evoked envelope 2, Evoked envelope 6, Evoked envelope 4, Evoked envelope 0, Evoked envelope 1, Evoked envelope 2, Evoked envelope 6, Evoked envelope 4, Evoked envelope 0, Evoked envelope 1, Evoked envelope 2, Evoked envelope 6, Evoked envelope 4
   :srcset: /auto_examples/multicsc/images/sphx_glr_plot_sample_evoked_response_002.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Displaying 0-th atom envelopeUsing data from preloaded Raw for 72 events and 91 original time points ...
    0 bad epochs dropped
    Using data from preloaded Raw for 73 events and 91 original time points ...
    0 bad epochs dropped
    Using data from preloaded Raw for 73 events and 91 original time points ...
    0 bad epochs dropped
    Using data from preloaded Raw for 70 events and 91 original time points ...
    0 bad epochs dropped
    Displaying 1-th atom envelopeUsing data from preloaded Raw for 72 events and 91 original time points ...
    0 bad epochs dropped
    Using data from preloaded Raw for 73 events and 91 original time points ...
    0 bad epochs dropped
    Using data from preloaded Raw for 73 events and 91 original time points ...
    0 bad epochs dropped
    Using data from preloaded Raw for 70 events and 91 original time points ...
    0 bad epochs dropped
    Displaying 2-th atom envelopeUsing data from preloaded Raw for 72 events and 91 original time points ...
    0 bad epochs dropped
    Using data from preloaded Raw for 73 events and 91 original time points ...
    0 bad epochs dropped
    Using data from preloaded Raw for 73 events and 91 original time points ...
    0 bad epochs dropped
    Using data from preloaded Raw for 70 events and 91 original time points ...
    0 bad epochs dropped
    Displaying 6-th atom envelopeUsing data from preloaded Raw for 72 events and 91 original time points ...
    0 bad epochs dropped
    Using data from preloaded Raw for 73 events and 91 original time points ...
    0 bad epochs dropped
    Using data from preloaded Raw for 73 events and 91 original time points ...
    0 bad epochs dropped
    Using data from preloaded Raw for 70 events and 91 original time points ...
    0 bad epochs dropped
    Displaying 4-th atom envelopeUsing data from preloaded Raw for 72 events and 91 original time points ...
    0 bad epochs dropped
    Using data from preloaded Raw for 73 events and 91 original time points ...
    0 bad epochs dropped
    Using data from preloaded Raw for 73 events and 91 original time points ...
    0 bad epochs dropped
    Using data from preloaded Raw for 70 events and 91 original time points ...
    0 bad epochs dropped
                          Displayed 5 atoms




.. GENERATED FROM PYTHON SOURCE LINES 268-285

Display the equivalent dipole for a learned topomap
---------------------------------------------------

Finally, let us fit a dipole to one of the atoms. To fit a dipole,
we need the following:

* BEM solution: Obtained by running the cortical reconstruction pipeline
  of Freesurfer and describes the conductivity of different tissues in
  the head.
* Trans: An affine transformation matrix needed to bring the data
  from sensor space to head space. This is usually done by coregistering
  the fiducials with the MRI.
* Noise covariance matrix: To whiten the data so that the assumption
  of Gaussian noise model with identity covariance matrix is satisfied.

We recommend users to consult the MNE documentation for further information.


.. GENERATED FROM PYTHON SOURCE LINES 285-293

.. code-block:: default

    subjects_dir = os.path.join(data_path, 'subjects')
    fname_bem = os.path.join(subjects_dir, 'sample', 'bem',
                             'sample-5120-bem-sol.fif')
    fname_trans = os.path.join(data_path, 'MEG', 'sample',
                               'sample_audvis_raw-trans.fif')
    fname_cov = os.path.join(data_path, 'MEG', 'sample', 'sample_audvis-cov.fif')









.. GENERATED FROM PYTHON SOURCE LINES 294-297

Let us construct an evoked object for MNE with the spatial pattern of the
atoms.


.. GENERATED FROM PYTHON SOURCE LINES 297-300

.. code-block:: default

    evoked = mne.EvokedArray(cdl.u_hat_.T, info)









.. GENERATED FROM PYTHON SOURCE LINES 301-303

Fit a dipole to each of the atoms.


.. GENERATED FROM PYTHON SOURCE LINES 303-307

.. code-block:: default

    dip = mne.fit_dipole(evoked, fname_cov, fname_bem, fname_trans,
                         n_jobs=n_jobs, verbose=False)[0]









.. GENERATED FROM PYTHON SOURCE LINES 308-311

Plot the dipole fit from the 3rd atom, linked to mu-wave and display the
goodness of fit.


.. GENERATED FROM PYTHON SOURCE LINES 311-339

.. code-block:: default


    atom_dipole_idx = 4

    from mpl_toolkits.mplot3d import Axes3D

    fig = plt.figure(figsize=(10, 4))

    # Display the dipole fit
    ax = fig.add_subplot(1, 3, 1, projection='3d')
    dip.plot_locations(fname_trans, 'sample', subjects_dir, idx=atom_dipole_idx,
                       ax=ax)
    ax.set_title('Atom #{} (GOF {:.2f}%)'.format(atom_dipole_idx,
                                                 dip.gof[atom_dipole_idx]))

    # Plot the spatial map
    ax = fig.add_subplot(1, 3, 2)
    mne.viz.plot_topomap(cdl.u_hat_[atom_dipole_idx], info, axes=ax)

    # Plot the temporal atom
    ax = fig.add_subplot(1, 3, 3)
    t = np.arange(n_times_atom) / sfreq
    ax.plot(t, cdl.v_hat_[atom_dipole_idx])
    ax.set_xlim(0, n_times_atom / sfreq)
    ax.set(xlabel='Time (sec)', title="Temporal pattern {}"
           .format(atom_dipole_idx))

    fig.suptitle('')
    fig.tight_layout()



.. image-sg:: /auto_examples/multicsc/images/sphx_glr_plot_sample_evoked_response_003.png
   :alt: , Atom #4 (GOF 79.30%), Temporal pattern 4
   :srcset: /auto_examples/multicsc/images/sphx_glr_plot_sample_evoked_response_003.png
   :class: sphx-glr-single-img






.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 92 minutes  49.728 seconds)


.. _sphx_glr_download_auto_examples_multicsc_plot_sample_evoked_response.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example


    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: plot_sample_evoked_response.py <plot_sample_evoked_response.py>`

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: plot_sample_evoked_response.ipynb <plot_sample_evoked_response.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
